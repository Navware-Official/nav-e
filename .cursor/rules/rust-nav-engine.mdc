---
description: Rust nav_engine and nav_e_ffi structure; DDD/Hexagonal
globs: native/**/*.rs
alwaysApply: false
---

# Rust nav_engine & FFI

## Layout
- **nav_engine**: Domain (`domain/`), application CQRS (`application/`), infrastructure adapters (`infrastructure/`), internal API (`api/`). Business logic and ports live here.
- **nav_e_ffi**: Thin wrapper in `native/nav_e_ffi/src/lib.rs`. Only `#[frb]`-annotated public functions; delegate to `nav_engine::api::*`.

## Adding or changing an API
1. Implement or extend the internal API in `native/nav_engine/src/api/` (e.g. `routes.rs`, `device_comm.rs`).
2. Add or update the corresponding wrapper in `native/nav_e_ffi/src/lib.rs`: simple pass-through with `#[frb]`, same types that flutter_rust_bridge supports.
3. Run `make codegen`; update Dart call sites. Run `make test-rust` (or `make test`) to verify.

## Conventions
- Use `make fmt` and `make build-native`. No business logic in nav_e_ffi â€” only forwarding.
- Device comm / protobuf: see `native/device_comm`, `proto/`, and `docs/rust/device-comm.md`, `docs/rust/protobuf.md`.
