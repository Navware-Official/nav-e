---
description: BLoC/Cubit patterns and feature layout for Flutter
globs: lib/**/*.dart
alwaysApply: false
---

# Dart BLoC & feature layout

## Feature structure
- `lib/features/<feature>/`: `presentation/` (screens, widgets, bloc), `cubit/` or `bloc/`, domain/data if needed.
- Events: `*_events.dart`; States: `*_states.dart`. Use `const` constructors and `Equatable` (or override `==`) for states.

## BLoC
- Inject dependencies via constructor (e.g. `DeviceCommunicationService`); register in `main.dart` or parent.
- Register handlers in constructor: `on<EventType>(_onHandler);` â€” keep handlers `async` and use `Emitter<State> emit`.
- Use `emit(newState)` for every transition; do not emit after closing/async gaps without checking `isClosed`.
- Subscribe to streams in constructor and `add()` events from callbacks; cancel in `close()`.

## Cubit
- Use for local/simple state (e.g. theme, offline list). Use `emit(state)` for updates.

## Conventions
- Run `flutter analyze`; follow Effective Dart. Use `make test` for Flutter + Rust tests.
