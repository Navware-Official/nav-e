name: FRB Codegen & Native Build

on:
  push:
    branches: [ main, master ]
    paths:
      - 'native/**'
      - 'flutter_rust_bridge.yaml'
      - 'Makefile'
      - '.github/workflows/frb_codegen_build.yml'
  workflow_call:

jobs:
  codegen-and-build:
    name: Generate FRB bindings and build native crate
    runs-on: ubuntu-latest
    steps:
      - name: Checkout (full history)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect whether native/Makefile/FRB config changed (skip heavy work when possible)
        id: detect-changes
        run: |
          NEED_CODEGEN=false
          echo "GITHUB_EVENT_NAME=$GITHUB_EVENT_NAME"
          # On pull_request event, inspect the PR's changed files using the event payload
          if [ "$GITHUB_EVENT_NAME" = "pull_request" ]; then
            echo "Detecting files changed in PR..."
            # Use jq to parse base/head refs from the event payload
            if command -v jq >/dev/null 2>&1 && [ -f "$GITHUB_EVENT_PATH" ]; then
              BASE_REF=$(jq -r .pull_request.base.ref < "$GITHUB_EVENT_PATH")
              HEAD_SHA=$(jq -r .pull_request.head.sha < "$GITHUB_EVENT_PATH")
              echo "Base ref: $BASE_REF"
              echo "Head sha: $HEAD_SHA"
              git fetch origin "$BASE_REF" --depth=1 || true
              CHANGED_FILES=$(git diff --name-only "origin/$BASE_REF...$HEAD_SHA" || true)
              echo "Changed files:"
              echo "$CHANGED_FILES"
              if echo "$CHANGED_FILES" | grep -E '^(native/|Makefile|flutter_rust_bridge.yaml)' >/dev/null 2>&1; then
                NEED_CODEGEN=true
              else
                NEED_CODEGEN=false
              fi
            else
              echo "Warning: jq or event payload missing; defaulting to run codegen"
              NEED_CODEGEN=true
            fi
          else
            # For push / workflow_dispatch / other events, we want codegen+build to run
            NEED_CODEGEN=true
          fi

          echo "need_codegen=$NEED_CODEGEN" >> "$GITHUB_OUTPUT"
          echo "::notice::need_codegen=$NEED_CODEGEN"

      - name: Install apt packages
        if: steps.detect-changes.outputs.need_codegen == 'true'
        run: |
          sudo apt-get update
          sudo apt-get install -y pkg-config libssl-dev build-essential clang protobuf-compiler

      - name: Setup Flutter
        if: steps.detect-changes.outputs.need_codegen == 'true'
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.0'
          channel: 'stable'

      - name: Setup Rust toolchain
        if: steps.detect-changes.outputs.need_codegen == 'true'
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          profile: minimal
          override: true

      - name: Cache cargo registry and target
        if: steps.detect-changes.outputs.need_codegen == 'true'
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            native/nav_e_ffi/target
            native/nav_engine/target
            native/device_comm/target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-

      - name: Cache flutter_rust_bridge_codegen
        id: cache-frb
        if: steps.detect-changes.outputs.need_codegen == 'true'
        uses: actions/cache@v4
        with:
          path: ~/.cargo/bin/flutter_rust_bridge_codegen
          key: ${{ runner.os }}-frb-codegen-2.11.1

      - name: Install flutter_rust_bridge_codegen
        if: steps.detect-changes.outputs.need_codegen == 'true' && steps.cache-frb.outputs.cache-hit != 'true'
        run: |
          cargo install flutter_rust_bridge_codegen --version 2.11.1 --locked

      - name: Run codegen via Makefile
        if: steps.detect-changes.outputs.need_codegen == 'true'
        working-directory: ${{ github.workspace }}
        run: |
          make codegen

      - name: Build native via Makefile
        if: steps.detect-changes.outputs.need_codegen == 'true'
        working-directory: ${{ github.workspace }}
        run: |
          make build-native

      - name: Ensure lib/bridge exists before upload
        id: ensure-bindings
        run: |
          if [ -d "lib/bridge" ] && ls lib/bridge/*.dart >/dev/null 2>&1; then
            echo "bindings_present=true" >> "$GITHUB_OUTPUT"
            echo "Bindings are present in lib/bridge/"
          else
            echo "bindings_present=false" >> "$GITHUB_OUTPUT"
            echo "No generated bindings were found in lib/bridge/"
          fi

      - name: Upload FRB bindings artifact
        if: steps.ensure-bindings.outputs.bindings_present == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: frb-bindings
          path: lib/bridge/
          retention-days: 1

      - name: Fail early if no bindings available
        if: steps.ensure-bindings.outputs.bindings_present == 'false'
        run: |
          echo "‚ùå No FRB Dart bindings available to upload."
          echo "If you expect the generator to run in this workflow, please ensure codegen ran."
          echo "If codegen was intentionally skipped (no native changes), make sure lib/bridge/ is committed to the branch."
          exit 1

      - name: Upload native libs artifact (only when we built)
        if: steps.detect-changes.outputs.need_codegen == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: native-libs
          path: |
            native/nav_e_ffi/target/release
            native/nav_engine/target/release
            native/device_comm/target/release
          retention-days: 1