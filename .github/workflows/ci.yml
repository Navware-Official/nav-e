name: CI
on:
  pull_request:
    branches: [ main, 'release/*' ]
  push:
    branches: [ main ]

jobs:
  generate-bindings:
    uses: ./.github/workflows/frb_codegen_build.yml

  flutter-checks:
    runs-on: ubuntu-latest
    needs: generate-bindings
    steps:
      - uses: actions/checkout@v4
          
      - uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true

      - name: Check if lib/bridge is committed in this branch
        id: check-bridge-repo
        run: |
          if [ -d "lib/bridge" ] && ls lib/bridge/*.dart >/dev/null 2>&1; then
            echo "bridge_in_repo=true" >> "$GITHUB_OUTPUT"
          else
            echo "bridge_in_repo=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Download FRB bindings artifact (to temp dir)
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          name: frb-bindings
          path: tmp/frb_artifact/

      - name: Verify FRB bindings (artifact vs repo) and prepare lib/bridge
        run: |
          set -euo pipefail

          DLD_DIR="tmp/frb_artifact"
          # artifact was uploaded from lib/bridge/ so downloaded tree will normally be DLD_DIR/lib/bridge/...
          ART_BRIDGE_DIR=""
          if [ -d "$DLD_DIR/lib/bridge" ]; then
            ART_BRIDGE_DIR="$DLD_DIR/lib/bridge"
          elif [ -d "$DLD_DIR" ] && ls "$DLD_DIR"/*.dart >/dev/null 2>&1; then
            # fallback: downloaded files at top-level (rare)
            ART_BRIDGE_DIR="$DLD_DIR"
          fi

          REPO_HAS_BRIDGE="${{ steps.check-bridge-repo.outputs.bridge_in_repo }}"

          if [ -n "$ART_BRIDGE_DIR" ] && ls "$ART_BRIDGE_DIR"/*.dart >/dev/null 2>&1; then
            echo "Found FRB bindings in artifact at $ART_BRIDGE_DIR"
            if [ "$REPO_HAS_BRIDGE" = "true" ]; then
              echo "Repository contains lib/bridge/ — comparing artifact against committed files..."
              
              # Format both artifact and repo bindings to normalize formatting differences
              echo "Normalizing formatting on artifact bindings..."
              dart format "$ART_BRIDGE_DIR" >/dev/null 2>&1 || true
              
              echo "Normalizing formatting on repo bindings..."
              dart format lib/bridge >/dev/null 2>&1 || true
              
              TMP_DIFF=$(mktemp)
              set +e
              diff -ru "$ART_BRIDGE_DIR" lib/bridge > "$TMP_DIFF" || true
              set -e
              
              if [ -s "$TMP_DIFF" ]; then
                echo "⚠️ Committed lib/bridge differs from generated bindings artifact."
                echo ""
                echo "Checking if differences are only cosmetic (whitespace/formatting)..."
                
                # Check if differences are only whitespace/formatting by comparing normalized content
                SIGNIFICANT_DIFF=false
                for file in "$ART_BRIDGE_DIR"/*.dart; do
                  basename=$(basename "$file")
                  if [ -f "lib/bridge/$basename" ]; then
                    # Remove all whitespace and compare
                    if ! diff -w <(tr -d '[:space:]' < "$file") <(tr -d '[:space:]' < "lib/bridge/$basename") >/dev/null 2>&1; then
                      SIGNIFICANT_DIFF=true
                      break
                    fi
                  else
                    SIGNIFICANT_DIFF=true
                    break
                  fi
                done
                
                if [ "$SIGNIFICANT_DIFF" = "true" ]; then
                  echo "❌ Found significant differences (not just formatting)."
                  echo ""
                  echo "To fix locally:"
                  echo "  ./scripts/generate_bindings.sh"
                  echo "  git add lib/bridge"
                  echo "  git commit -m \"chore: regenerate flutter-rust-bridge bindings\""
                  echo ""
                  echo "Diff (artifact -> committed) (first 200 lines):"
                  sed -n '1,200p' "$TMP_DIFF" || true
                  rm -f "$TMP_DIFF"
                  exit 1
                else
                  echo "✅ Differences are only cosmetic (formatting/whitespace). Using committed bindings."
                fi
              else
                echo "✅ Artifact and committed lib/bridge match perfectly."
              fi
              rm -f "$TMP_DIFF"
            else
              echo "Repository does not contain lib/bridge — copying artifact into lib/bridge for tests..."
              rm -rf lib/bridge || true
              mkdir -p lib/bridge
              cp -a "$ART_BRIDGE_DIR"/. lib/bridge/
            fi
          else
            if [ "$REPO_HAS_BRIDGE" = "true" ]; then
              echo "No artifact found — will use committed lib/bridge in the repository."
            else
              echo "❌ No FRB bindings available. Neither a generated artifact was uploaded nor lib/bridge is committed in the branch."
              echo "If your change touches native/Rust code, FRB codegen should have run and uploaded an artifact."
              echo "If your change is Flutter-only, generate lib/bridge locally and commit it (./scripts/generate_bindings.sh)."
              exit 1
            fi
          fi

      - name: Flutter deps
        run: flutter pub get

      - name: Format check (exclude generated)
        run: |
          set -euo pipefail
          # find .dart files excluding lib/bridge, handle spaces safely
          mapfile -d '' FILES < <(find lib -name '*.dart' ! -path 'lib/bridge/*' -print0)
          if [ "${#FILES[@]}" -eq 0 ]; then
            echo "No Dart files to format-check (excluding lib/bridge)."
          else
            # Pass files safely to dart format
            printf '%s\0' "${FILES[@]}" | xargs -0 dart format --output=none --set-exit-if-changed
          fi

      - name: Analyze
        run: dart analyze

      - name: Tests
        run: flutter test --coverage