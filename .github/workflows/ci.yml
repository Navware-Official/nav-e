name: CI
on:
  pull_request:
    branches: [ main, 'release/*' ]
  push:
    branches: [ main ]

jobs:
  generate-bindings:
    uses: ./.github/workflows/frb_codegen_build.yml

  flutter-checks:
    runs-on: ubuntu-latest
    needs: generate-bindings
    steps:
      - uses: actions/checkout@v4
      
      - uses: subosito/flutter-action@v2
        with: 
          channel: stable
          cache: true
      
      - name: Download FRB bindings
        uses: actions/download-artifact@v4
        with:
          name: frb-bindings
          path: lib/bridge/
      
      - name: Flutter deps
        run: flutter pub get
      
      - name: Format check (exclude generated)
        run: dart format --output=none --set-exit-if-changed $(find lib -name '*.dart' ! -path 'lib/bridge/*')
      
      - name: Analyze
        run: dart analyze
      
      - name: Tests
        run: flutter test --coverage
  
  rust-checks:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Install apt packages
        run: |
          sudo apt-get update
          sudo apt-get install -y pkg-config libssl-dev build-essential clang protobuf-compiler
      
      - name: Setup Rust toolchain
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          profile: minimal
          override: true
          components: rustfmt, clippy
      
      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            native/nav_engine/target
            native/device_comm/target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
      
      - name: Rust format check
        working-directory: native/nav_engine
        run: cargo fmt -- --check
      
      - name: Rust clippy
        working-directory: native/nav_engine
        run: cargo clippy -- -D warnings
      
      - name: Rust tests
        working-directory: native/nav_engine
        run: cargo test